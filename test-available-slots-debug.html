<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Horarios Disponibles</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .slots-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 10px; }
        .slot-button { padding: 8px; border: 1px solid #007bff; background: #f8f9fa; cursor: pointer; border-radius: 3px; }
        .slot-button:hover { background: #e9ecef; }
        .available { background: #d4edda; border-color: #c3e6cb; }
        .occupied { background: #f8d7da; border-color: #f5c6cb; cursor: not-allowed; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .logs { background: #f8f9fa; padding: 10px; border: 1px solid #ddd; max-height: 400px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üïê Test - Horarios Disponibles</h1>
        
        <div class="section">
            <h3>1. Par√°metros de Prueba</h3>
            <div>
                <label>Barbero ID: </label>
                <input type="text" id="barberId" placeholder="ID del barbero" value="">
            </div>
            <div>
                <label>Servicio ID: </label>
                <input type="text" id="serviceId" placeholder="ID del servicio" value="">
            </div>
            <div>
                <label>Fecha: </label>
                <input type="date" id="date" value="">
            </div>
            <button onclick="getBarbers()">Obtener Barberos</button>
            <button onclick="getServices()">Obtener Servicios</button>
            <button onclick="getAvailableSlots()">Obtener Horarios Disponibles</button>
        </div>

        <div class="section">
            <h3>2. Barberos Disponibles</h3>
            <div id="barbersContainer"></div>
        </div>

        <div class="section">
            <h3>3. Servicios Disponibles</h3>
            <div id="servicesContainer"></div>
        </div>

        <div class="section">
            <h3>4. Horarios Disponibles</h3>
            <div id="slotsContainer"></div>
        </div>

        <div class="section">
            <h3>5. Citas Existentes (Para Debug)</h3>
            <button onclick="getExistingAppointments()">Ver Citas de Hoy</button>
            <div id="appointmentsContainer"></div>
        </div>

        <div class="section">
            <h3>6. Crear Cita de Prueba</h3>
            <div>
                <label>Hora de inicio: </label>
                <input type="time" id="testStartTime" value="10:00">
                <button onclick="createTestAppointment()">Crear Cita</button>
            </div>
        </div>

        <div class="section">
            <h3>7. Logs del Sistema</h3>
            <button onclick="clearLogs()">Limpiar Logs</button>
            <div id="logs" class="logs"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let authToken = null;

        // Funci√≥n para logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('logs');
            const logMessage = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logElement.textContent += logMessage;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').textContent = '';
        }

        // Login autom√°tico como admin
        async function autoLogin() {
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@barbershop.com',
                        password: 'admin123'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    log('‚úÖ Login autom√°tico exitoso');
                } else {
                    log('‚ùå Error en login autom√°tico', 'error');
                }
            } catch (error) {
                log(`‚ùå Error en login: ${error.message}`, 'error');
            }
        }

        // Obtener barberos
        async function getBarbers() {
            try {
                log('üîç Obteniendo barberos...');
                const response = await fetch(`${API_BASE}/barbers`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ ${data.data.length} barberos encontrados`);
                    
                    const container = document.getElementById('barbersContainer');
                    container.innerHTML = data.data.map(barber => `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd;">
                            <strong>${barber.user?.name}</strong> (ID: ${barber._id})
                            <button onclick="selectBarber('${barber._id}')">Seleccionar</button>
                            <div>Disponibilidad: ${JSON.stringify(barber.availability)}</div>
                        </div>
                    `).join('');
                } else {
                    log('‚ùå Error obteniendo barberos', 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Obtener servicios
        async function getServices() {
            try {
                log('üîç Obteniendo servicios...');
                const response = await fetch(`${API_BASE}/services`);

                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ ${data.data.length} servicios encontrados`);
                    
                    const container = document.getElementById('servicesContainer');
                    container.innerHTML = data.data.map(service => `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd;">
                            <strong>${service.name}</strong> (ID: ${service._id})
                            <button onclick="selectService('${service._id}')">Seleccionar</button>
                            <div>Duraci√≥n: ${service.duration} min | Precio: $${service.price}</div>
                        </div>
                    `).join('');
                } else {
                    log('‚ùå Error obteniendo servicios', 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function selectBarber(barberId) {
            document.getElementById('barberId').value = barberId;
            log(`‚úÖ Barbero seleccionado: ${barberId}`);
        }

        function selectService(serviceId) {
            document.getElementById('serviceId').value = serviceId;
            log(`‚úÖ Servicio seleccionado: ${serviceId}`);
        }

        // Obtener horarios disponibles
        async function getAvailableSlots() {
            const barberId = document.getElementById('barberId').value;
            const serviceId = document.getElementById('serviceId').value;
            const date = document.getElementById('date').value;

            if (!barberId || !serviceId || !date) {
                log('‚ùå Faltan par√°metros: barberId, serviceId y date son requeridos', 'error');
                return;
            }

            try {
                log(`üîç Obteniendo horarios para barbero ${barberId}, servicio ${serviceId}, fecha ${date}...`);
                
                const url = `${API_BASE}/dashboard/barber/${barberId}/available-slots?date=${date}&serviceId=${serviceId}`;
                log(`üì° URL: ${url}`);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ ${data.data.length} horarios disponibles`);
                    log(`üìã Slots: ${JSON.stringify(data.data)}`);
                    
                    const container = document.getElementById('slotsContainer');
                    if (data.data.length > 0) {
                        container.innerHTML = `
                            <div class="slots-grid">
                                ${data.data.map(slot => `
                                    <div class="slot-button available">${slot}</div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        container.innerHTML = '<p>‚ùå No hay horarios disponibles</p>';
                    }
                } else {
                    const errorData = await response.json();
                    log(`‚ùå Error ${response.status}: ${errorData.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Obtener citas existentes
        async function getExistingAppointments() {
            const barberId = document.getElementById('barberId').value;
            const date = document.getElementById('date').value;

            if (!barberId || !date) {
                log('‚ùå Faltan par√°metros: barberId y date son requeridos', 'error');
                return;
            }

            try {
                log('üîç Obteniendo citas existentes...');
                const response = await fetch(`${API_BASE}/appointments?barberId=${barberId}&startDate=${date}&endDate=${date}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ ${data.appointments?.length || 0} citas encontradas`);
                    
                    const container = document.getElementById('appointmentsContainer');
                    if (data.appointments && data.appointments.length > 0) {
                        container.innerHTML = data.appointments.map(apt => `
                            <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd;">
                                <strong>Cita ID:</strong> ${apt._id}<br>
                                <strong>Fecha:</strong> ${new Date(apt.date).toLocaleDateString()}<br>
                                <strong>Hora:</strong> ${apt.startTime} - ${apt.endTime}<br>
                                <strong>Estado:</strong> ${apt.status}<br>
                                <strong>Cliente:</strong> ${apt.client?.name}<br>
                                <strong>Servicio:</strong> ${apt.service?.name}
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p>‚úÖ No hay citas para esta fecha</p>';
                    }
                } else {
                    log('‚ùå Error obteniendo citas', 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Crear cita de prueba
        async function createTestAppointment() {
            const barberId = document.getElementById('barberId').value;
            const serviceId = document.getElementById('serviceId').value;
            const date = document.getElementById('date').value;
            const startTime = document.getElementById('testStartTime').value;

            if (!barberId || !serviceId || !date || !startTime) {
                log('‚ùå Faltan par√°metros para crear la cita', 'error');
                return;
            }

            try {
                log('üìù Creando cita de prueba...');
                const response = await fetch(`${API_BASE}/appointments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        barberId,
                        serviceId,
                        date,
                        startTime,
                        notes: 'Cita de prueba'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Cita creada exitosamente');
                    log(`üìã Detalles: ${JSON.stringify(data.data, null, 2)}`);
                } else {
                    const errorData = await response.json();
                    log(`‚ùå Error creando cita: ${errorData.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Inicializar
        window.onload = function() {
            // Establecer fecha de hoy
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            
            // Login autom√°tico
            autoLogin();
            
            log('üöÄ Sistema de prueba iniciado');
        };
    </script>
</body>
</html> 